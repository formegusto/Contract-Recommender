# 아파트 전기계약 추천 시스템

# 개요

> **아파트 전기계약으로는 단일계약과 종합계약으로 구분이 된다.**

- `종합계약`
  - **한전(KEPCO)이 각 가구들을 직접 검침**하는 방식.
  - **가구별**로 **“주택용 저압” 가격이 적용**된다.
  - **공공시설물들**에 대한 전기요금은 **“일반용 전력(갑) I” 로 적용**된다.
- `단일계약`
  - **아파트 관리사무소에서 직접 검침**하는 방식.
  - **한전 측에서는 아파트 전체 세대, 공공시설물들에 대한 Total 계량기를 검침**하는데, **주택용 고압** 가격을 적용한다.
    **[주택용 고압 부가설명]** **저압 요금제들은** 한전에서 고압(22,900V)의 전력을 일반가구에서 사용할 수 있는 (220V ~ 380V) 전력으로 변압 시켜보내기 때문이 **고압 요금제들에 비해 비싸다.**
    고압 요금제를 사용하는 건물은, 한전에 들어오는 고압의 전력을 변압시킬 수 있는 변압기를 자체적으로 가지고 있다는 것을 의미한다. 한전에서는 변압과정을 거치지 않아도 됨으로, 할인된 가격이 적용된다.

> **계약 선택의 중요성**

![아파트 전기계약의 특성으로 발생한 문제들에 대한 기사](https://user-images.githubusercontent.com/52296323/155925474-ee1c84f4-9cda-40b8-aeef-fbc15466c84d.png)

아파트 전기계약의 특성으로 발생한 문제들에 대한 기사

- `종합계약`
  - **주택용 저압 요금이 주택용 고압 요금보다 비싸다.** 그래서 단일계약에 비해, 각 가구들이 자신이 사용한 만큼 내야하는 비용의 비중이 높아진다.
  - 반면에 **공공시설물은 누진세가 적용되지 않는 “일반용 전력(갑) |” 을 사용**하기 때문에 **공공설비사용량이 많은 아파트에 유리한 요금제**이다.
- `단일계약`
  - **주택용 고압 요금이 주택용 저압 요금보다 싸다.** 그래서 종합계약에 비해, 각 가구들이 자신이 사용한 만큼 내야하는 비용의 비중이 낮아진다.
  - 하지만 문제는 **적게 사용한 가구와 많게 사용한 가구의 형평성**에서 나타난다.
    → 주택용 고압 요금은 **누진세**가 발생한다.
    → **공공설비사용량은 주택용 고압 요금**에 의해서 산정된다.
    → 적게 사용한 가구집단과 많게 사용한 가구집단이 있을 때, **많게 사용한 가구집단에 의해 공공설비사용량에 대한 요금에 누진세**가 붙어 **적게 사용한 가구집단의 공공설비요금 부담의 비중이 올라가게 된다.**

각 계약은 잘못된 선택에 의해서 **종합계약은** “우리 아파트는 공공설비사용량이 낮아서, 단일계약을 사용하면 전기요금을 줄일 수 있을텐데,,”, **단일계약은** “나는 전기를 적게 쓰는데도 공공설비사용요금이 많이 나오네,,” 와 같은 문제들이 생겨나게 된다.

**전기요금계약을 선택하는 것은 입주민들과 관리사무소의 선택**이다. 하지만 전기 요금은 일반인들의 입장에서 계산하기 곤란한 구조이며, 자신의 요금만이 아닌 아파트 전체의 상황을 봐야 어떤 계약이 올바른지 확인할 수 있다. 투명성 있게 계약 선택을 진행할 수 있는, **계산된 어떠한 지표가 필요**하다.

> **Contract Recommender**

- **1년치 전기사용량 데이터를 입력값으로 받아, 공공설비사용량에 따라 계약별 요금 변화를 확인하고, 전기요금계약을 추천해주는 시스템**
- **공공설비사용요금은 “파레토 최적점” 상태라는 공공재의 성격을 가지고 있다.**
  - 누군가가 손해보지 않으면 모두가 n분의 1 의 비용을 지불한다.
  - **아파트 전체 사용 요금**과 **종합계약에 유리한 가구 비율, 단일계약에 유리한 가구 비율**을 지표로 출력값으로, 요금계약을 추천해주도록 한다.
    - 다수결의 원칙에 따르도록 한다.

# Contract Recommender

## 1. 시스템 구성도

![Untitled](https://user-images.githubusercontent.com/52296323/155935230-fcf609b5-f54b-40ea-ad6e-359cce7be0d9.png)

| View                                                                                    | º 사용자가 바라보는 데스크톱 애플리케이션(electron, typescript)으로, 계약 추천을 받기 위한 파일 업로드 및 계약 추천 보고서의 출력의 역할을 한다.                                                                                                                                  |
| --------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Server                                                                                  | º 해당 추천 프로세스에는 크기가 큰 데이터의 입출력, 행렬분해 등과 같은 Client-Side에서 View 처리와 동반하기에는 자원소모가 큰 로직들이 포함되어 있다. 실시간 처리 확인 과정에서 끊김없는 View의 업데이트를 보여주기 위해 View와 소켓이 연결된 서버(node.js, typescript)를 두었다. |
| º 사용자의 입력 처리, 추천 프로세스 프로그램 실행, 실시간 처리 과정 알림의 역할을 한다. |
| Processing Program                                                                      | º 실질적인 추천 프로세스가 실행되는 프로그램(python)이다. 서버가 사용자의 입력처리를 끝내면, child_process library에 의해 실행이 된다.                                                                                                                                            |
| Store                                                                                   | º 서버가 추천 프로세스 프로그램을 실행 시키면, 해당 프로그램이 각 프로세스 단계가 끝날 때 마다, 작업의 출력물과 새로운 단계의 시작을 Database측에 업데이트 시킨다. 그리고 Server에 작업이 업데이트 됐다는 API 호출을 통해, Server는 실시간 작업 과정 알림을 View에게 알린다.      |

º 출력물 저장 뿐만이 아니라, View-Server-Processing Program 3개의 노드 간의 커뮤니케이션을 위해 사용하는 Store 이다.
º 많은 비정형 데이터가 들어가기 때문에 관계형 데이터베이스가 아닌, NoSQL MongoDB를 이용했다. |

## 2. 추천 프로세스

### 1. load excel

> 엑셀을 읽는 작업으로, 서버 측에서는 multer library를 통해 파일을 저장하고, Database에 해당 정보를 저장한다. 이후, 저장된 정보를 process program의 매개변수로 전달하여, process program은 해당 정보를 가지고, 추천 프로세스의 진행을 시작한다.

![Untitled 1](https://user-images.githubusercontent.com/52296323/155935253-07b265d3-26d2-4357-a7a7-f598a00ad26d.png)

![Untitled 2](https://user-images.githubusercontent.com/52296323/155935271-8b1b5209-1cf0-4e6a-8975-e31bafe32b7b.png)

### 2. Data Preprocess (데이터 전처리)

> 시뮬레이션의 핵심은 세대 전체의 사용량이 정해진 상태에서, 공동설비사용량을 1%씩 올려가면서, 최종청구금액이 종합계약에 저렴한 가구가 많은지, 단일계약에 저렴한 가구가 많은지에 대해 체크하는 것이다. 해당 작업을 위해서는 15분 사용량이 아닌, 15분 사용량이 합쳐져서 만들어진 월 별 총 사용량 데이터가 필요하기 때문에 데이터 전처리 작업을 진행한다.

### 3. bill calc (청구서 계산)

> 전처리 된 데이터를 이용해서 사용자가 시뮬레이션을 등록할 때 설정한 시뮬레이션의 공동설비사용량 범위의 최소값부터 최대값 까지 공동설비사용량을 늘려가며, 계약별(종합계약, 단일계약) 각 가구들의 최종청구금액을 계산한다. 추가적으로 아파트전체사용요금, 공동설비사용요금도 계산을 한다. 출력 데이터는 월 별로 계산이 들어가기 때문에 12개의 리스트 형태로 반환이 된다.

![Untitled 3](https://user-images.githubusercontent.com/52296323/155935281-4431f43c-4f4c-4d13-9492-5f20508947d3.png)

### 4. normal analysis (일반 분석)

> 계산된 청구서 데이터를 이용하여 분석을 시작한다. 월 별로 계산되어 있는 가구별 최종청구서, 아파트전체사용요금, 공동설비사용요금을 계약별로 비교하여, 유리 가구 수, 아파트 전체 사용요금, 공동설비사용요금, 평균 손실율 카테고리 별로 종합계약이 유리해지는 percentage 지점을 찾는 것 이다.

- 유리 가구 수 : 특정 가구가 계약별 최종청구금액상에서 종합계약이 저렴하면 종합계약의 유리가구 수가 +1 카운트되고, 단일계약이 저렴하면 단일계약의 유리가구 수가 +1 카운트된다.
- 아파트 전체 사용요금 : 특정 아파트가 세대 전체 최종청구금액 + 공동설비사용요금 면에서 종합계약이 저렴해지는 시점을 기록한다.
- 공동설비사용요금 : 공동설비사용요금 면에서 종합계약이 저렴해지는 시점을 기록한다.
- 평균 손해율 : 위에서 유리가구 수에 대해서 설명을 했는데, 이는 종합계약에 유리한 가구 들이 단일계약을 이용할 경우 단일계약 최종청구금액 / 종합계약 최종청구금액 \* 100 으로 계산되어 원래 유리한 계약과 비교했을 때의 손실율을 나타내며, 이들의 손해율의 평균을 보여주는 지표이다. 이 또한 종합계약이 유리해지는 시점을 기록한다.

### 5. mean analysis (평균 분석)

> 일반 분석의 단점은 1년의 12개의 월의 분석을 진행하기 때문에, 단 하나의 종합계약 유리시점을 추천해주지 못한다는 것이 존재한다. 그래서 각 가구별 1년치 월 별 총 사용량 데이터의 평균으로 다시 청구서 계산을 하고, 이를 일반 분석에 돌려서 평균치에 따른 분석 결과를 제공한다.

![Untitled 4](https://user-images.githubusercontent.com/52296323/155935293-fd60e296-6ed2-43f2-925d-e6d3cfddf187.png)

![](https://user-images.githubusercontent.com/52296323/155935300-da5d66c3-233a-4181-a914-e8314e2caf30.png)

관리사무소 측에서 많은 관점으로 계약 선정을 할 수 있도록, 유리 가구 수 측면 외에도 다른 분석 결과를 출력했다.

> 추가적으로 평균 분석 부터는 가구들의 사용량 분포를 알 수 있는 histogram 데이터가 제공된다. 단일계약은 공동설비사용량이 증가할 수록 최소사용량 가구부터 종합계약 쪽의 최종청구금액이 저렴해지는 특징이 있는데, 모든 가구를 고려한 시점에서, 최소사용량 가구가 종합계약이 유리해졌던 시점을 비교하여 관리사무소에서 계약을 선택할 수 있도록 하기 위함이다.

![Untitled 6](https://user-images.githubusercontent.com/52296323/155935347-50b3cb85-5a46-4090-bfa4-b576616d87be.png)

### 6. similarity analysis (유사도 분석)

> 평균이라는 값은 특성적 측면에서 모든 값의 특성을 담아낸 값이라고 볼 수 있다. 하지만, 노이즈라 불리우는 어떠한 사물을 표현하는데에 많이 쓰이지 않는 특성 까지도 다른 특성과 같은 비율로 담아낸다는 점에서 **대체적으로 사용하는 값** 이라는 측면의 설명력이 부족해진다.

![Untitled 7](https://user-images.githubusercontent.com/52296323/155935357-c2b38ce3-2870-4847-82d2-1cfdbd988676.png)

> 유사도 분석치는 월-가구의 테이블에서 대체적으로 사용되어진 패턴들을 찾아낸 후,(거리 혹은 방향성 면에서 우수한 패턴) 이들의 조합으로 만들어진 **각 가구들의 대체적으로 사용하는 값** 으로 설명을 해주는 값이다. 이를 통해 평균분석의 진행방법으로 분석을 다시 한 번 진행시킨다.

![Untitled 8](https://user-images.githubusercontent.com/52296323/155935363-8879c49b-b079-4957-b5fc-be2e3faaea68.png)

![Untitled 9](https://user-images.githubusercontent.com/52296323/155935373-1463350a-3d66-49d2-b3fa-847e6fb9e928.png)

![Untitled 10](https://user-images.githubusercontent.com/52296323/155935387-fc7398c2-9ef4-49d9-8ead-a4b45c21a5fe.png)

> 유사도 분석치의 결과는 모든 경우의 수로 만들어진 평균과 다르게, 대체적으로 사용하는 값들로 만들어진 것으로, 이를 통한 분석결과는 사용자에게 또 다른 관점의 추천 시점을 보여줄 수 있다.
